---
name: plan-mode
description: Decision-complete planning workflow that clarifies intent, explores the repo, drafts a plan, verifies completeness, writes a plan file at planning/PLAN.md, and summarizes in chat. Use when a user asks for a plan, planning, execution plan, roadmap, or asks how to approach a task or feature.
---

# Plan Mode

Use this skill to produce a decision-complete plan and save it to `planning/PLAN.md`.

## Workflow

1. **Ground in the environment**
   - Inspect the repo first using non-mutating commands (`rg`, `ls`, `sed`, `cat`).
   - Do **not** use the network unless the user explicitly asks.
   - If in Plan Mode, do **not** write files.

2. **Clarify intent (strict)**
   - Always ask the fixed question set before drafting:
     - Goal
     - Success criteria
     - In-scope / out-of-scope
     - Constraints (tech, time, process, security, infra)
     - Audience / stakeholders
     - Timeline / deadlines
   - Ask these as popup-first batches using `request_user_input`:
     - Ask 1-3 questions per batch only.
     - Each question has 2-3 mutually exclusive options and recommended option first.
   - Always ask phase depth with these 3 options:
     - quick (1-3)
     - normal (3-5)
     - comprehensive (>5)
   - Default phase counts if the user does not specify an exact number:
     - quick -> 2 phases
     - normal -> 4 phases
     - comprehensive -> 6 phases
   - If `request_user_input` is unavailable, ask plain-text multiple-choice questions in chat.

3. **Research (integrated)**
   - Run integrated research before drafting the plan.
   - Research mode options:
     - ecosystem (default)
     - feasibility
     - implementation
     - comparison
   - Persist and reuse research preference in `planning/STATE.md`:
     - Read `preferences.research.enabled` and `preferences.research.mode` when state exists.
     - If missing, ask once and write defaults.
     - Reuse persisted values in later runs unless user explicitly overrides.
   - If `planning/RESEARCH.md` already exists, ask whether to:
     - update research
     - keep existing research
     - skip research for this run
   - Use local-first investigation:
     - inspect repo docs/code and existing architectural patterns
     - identify standard stack, architecture patterns, pitfalls, and non-goals
   - Use web/context docs only when requested by the user or when critical unknowns remain.
   - Write `planning/RESEARCH.md` using `references/research-template.md`.
   - Include confidence levels and source notes for major recommendations.

4. **Draft the plan (phased by user choice)**
   - Use the template in `references/plan-template.md`.
   - Ensure it is decision-complete: no unresolved decisions for the implementer.
   - Generate N phases based on the phase depth choice.
   - Use standardized numbering:
     - Base phases: zero-padded integers (`01`, `02`, `03`)
     - Optional inserted phases: decimals (`02.1`, `02.2`)
   - For each phase, follow this parseable format:
     - Heading: `### Phase <number>: <name>`
     - Goal line directly below heading: `- Goal: <goal>`
   - If `planning/RESEARCH.md` exists, incorporate:
     - `Standard Stack`
     - `Architecture Patterns`
     - `Don't Hand-Roll`
     - `Common Pitfalls`

5. **Auto bootstrap roadmap and state (always)**
   - After writing `planning/PLAN.md`, always generate or update:
     - `planning/ROADMAP.md`
     - `planning/STATE.md`
   - Deterministic parse rules from `planning/PLAN.md`:
     - Phase heading regex: `^### Phase ([0-9]{2}(\\.[0-9]+)?): (.+)$`
     - Goal regex: first bullet after heading matching `^- Goal: (.+)$`
   - Numbering policy:
     - Base phases: `01`, `02`, `03`
     - Inserted phases: `02.1`, `02.2`
   - Persist canonical per-phase state keys:
     - `phase_name`
     - `phase_dir`
     - `phase_status`
     - `step_status` (`discuss`, `plan`, `execute`)
   - Persist preferences in `planning/STATE.md`:
     - `preferences.research.enabled`
     - `preferences.research.mode`
     - `preferences.bootstrap.auto: true`
   - Overwrite policy:
     - If target file contains generated marker (`Generated by plan-mode` or `Generated by phase-orchestrator`), overwrite safely.
     - If marker is missing, ask for confirmation before overwrite.

6. **Verify**
   - Use `references/verification-checklist.md`.
   - Fix gaps before delivering.

7. **Deliver**
   - Write `planning/RESEARCH.md` when research was performed.
   - Write the full plan to `planning/PLAN.md` (create `planning/` if missing).
   - Write `planning/ROADMAP.md` and `planning/STATE.md` as part of the same run.
   - Also summarize key decisions and Next steps in chat.
   - If `planning/PLAN.md` exists:
     - If it contains `Generated by plan-mode`, replace entirely.
     - Otherwise, ask for confirmation before overwriting.

## Example Usage

Prompt: `Use $plan-mode to plan adding OAuth login with a normal (3-5) phase depth.`

## Output Rules

- Provide full file contents when writing `planning/PLAN.md`.
- When research runs, provide full file contents for `planning/RESEARCH.md`.
- Provide full file contents for `planning/ROADMAP.md` and `planning/STATE.md` from the same plan-mode run.
- Use popup selection questions when the tool is available.
- Always include a short **Next steps** section in chat.
- Use clean headings and short subtitles.
